<!DOCTYPE html>
<html>
<head>
    <title>Webmapping</title>
    <meta charset="utf-8" />
	
	<!-- Bibliothèque de base: Leaflet-->
    <link rel="stylesheet" href="libs/leaflet.css"/>
	<script src="libs/leaflet.js"></script>
	
	<!-- Draw-->
	<script src= "https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.2.3/leaflet.draw-src.js"></script>
	<link rel="stylesheet" href= "https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.2.3/leaflet.draw.css">
	<script src= "https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.2.3/leaflet.draw.js"></script>

	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==" crossorigin=""/>
	<script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw==" crossorigin=""></script>



	<!-- GeoCoder-->
	<link rel="stylesheet" href="libs/Control.OSMGeocoder.css"/>
	<script src="libs/Control.OSMGeocoder.js"></script>
	
	<!-- Overview-->
	<link rel="stylesheet" href="libs/overview/MiniMap.css" />
	<script src="libs/overview/MiniMap.js"></script>
 
	<!-- Location-->
	<link rel="stylesheet" href="libs/L.Control.Locate.min.css" />
    <script src="libs/L.Control.Locate.js"></script>
	
	<!-- Mouse position display-->
	<link rel="stylesheet" href="libs/L.Control.MousePosition.css" />
    <script src="libs/L.Control.MousePosition.js"></script>
	
	<!-- Navigation Bar-->
    <link rel="stylesheet" href="libs/NavBar/NavBar.css"/>
	<script src="libs/NavBar/NavBar.js"></script>
	
	<!-- Font-->
 	<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet">
	
	<!-- jquery -->
	<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>

	<!-- Legend menu-->
	<link rel="stylesheet" href="libs/slide_menu/SlideMenu.css" />
	<script src="libs/slide_menu/SlideMenu.js"></script>
	<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">

	
    <style>
        body {
            padding: 0;
            margin: 0;
        }
        html, body, #map {
            height: 100%;
            width: 100%;
        }
    </style>
	<script src="metadata-geojson.js"></script>
</head>
<body>
    <div id="map"></div>
	<script src="metadata-geojson.js" type="text/javascript"></script>
    <script>
	
		///// Fond de base
		var OpenStreetMap = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>'
        });
		var WorldImagery = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');
		var Mapbox_light = L.tileLayer('https://api.mapbox.com/styles/v1/cherylzuo/cji2tjfdj10032sp4xfjd7nvp/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiY2hlcnlsenVvIiwiYSI6ImNpeHQzNDBlMjAwMGIycW8xZnoxZXd1ZGIifQ.VJs34ZS05Q2xnJ5y54eZyQ', {
            attribution: '&copy; <a href="https://www.mapbox.com/">Mapbox</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>'
        });

		var Mapbox_dark = L.tileLayer('https://api.mapbox.com/styles/v1/cherylzuo/cji2tvfv60zr02rqdsvcl8w0m/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiY2hlcnlsenVvIiwiYSI6ImNpeHQzNDBlMjAwMGIycW8xZnoxZXd1ZGIifQ.VJs34ZS05Q2xnJ5y54eZyQ', {
            attribution: '&copy; <a href="https://www.mapbox.com/">Mapbox</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>'
        });


		///// Configuration the base map
		var map = L.map('map', {
				layers: [Mapbox_light], /// fond de base
				center: [31.2, 121.4],/// coordonnées
				zoom: 4,	//// zoom par defaut
				// crs: 'EPSG:4326'
				attribution: 'TUM'
			});
		

		/////layers de base		
		var baseLayers = {
			"Open Street Map": OpenStreetMap,
			"World Imagery": WorldImagery,
			"Light Map": Mapbox_light,
			"Dark Map": Mapbox_dark
		};

		//// Add the Search function to the map
		var osmGeocoder = new L.Control.OSMGeocoder();
        map.addControl(osmGeocoder);

        ///// Add the Overview to the map 
        var osm2 = L.tileLayer('https://api.mapbox.com/styles/v1/cherylzuo/cji2tjfdj10032sp4xfjd7nvp/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiY2hlcnlsenVvIiwiYSI6ImNpeHQzNDBlMjAwMGIycW8xZnoxZXd1ZGIifQ.VJs34ZS05Q2xnJ5y54eZyQ');
        var miniMap = new L.Control.MiniMap(osm2, { toggleDisplay: true }).addTo(map);

		///// Add the scale control to the map
		L.control.scale().addTo(map);

		///// Add the Navigation and Home Bar to the map
		L.control.navbar({position: 'topleft'}).addTo(map);

		///// Add the mouse position to the map 
		L.control.mousePosition().addTo(map);

		// Zoom control
		// L.control.zoom().addTo(map);


		/// layers à partir de Geoserver (format WMS)
		var points = L.tileLayer.wms("http://localhost:8080/geoserver/first/wms", {
			layers: 'fitst:points_cn',
			format: 'image/png',
			transparent: true,
			version: '1.1.0',
			// attribution: "LfK, TUM"
		});
		var railways = L.tileLayer.wms("http://localhost:8080/geoserver/first/wms", {
			layers: 'fitst:railways_cn',
			format: 'image/png',
			transparent: true,
			version: '1.1.0',
			// attribution: "LfK, TUM"
		});
		var buildings = L.tileLayer.wms("http://localhost:8080/geoserver/first/wms", {
			layers: 'fitst:buildings_cn',
			format: 'image/png',
			transparent: true,
			version: '1.1.0',
			// attribution: "LfK, TUM"
		});
		var landuse = L.tileLayer.wms("http://localhost:8080/geoserver/first/wms", {
			layers: 'fitst:landuse_cn',
			format: 'image/png',
			transparent: true,
			version: '1.1.0',
			attribution: "LfK, TUM"
		});
		var boundary = L.tileLayer.wms("http://localhost:8080/geoserver/first/wms", {
			layers: 'fitst:boundary_cn',
			format: 'image/png',
			transparent: true,
			version: '1.1.0',
			// attribution: "LfK, TUM"
		});

		var population_2000 = L.tileLayer.wms('http://sedac.ciesin.columbia.edu/geoserver/wms', {
			layers: 'gpw-v3:gpw-v3-population-density_2000',
			format: 'image/png',
			transparent: true,
			version: '1.1.0'
		});



		///// Groupe layers
		var overlays = {
			"population_2000": population_2000,
			"points": points,
			"railways": railways,
			"buildings": buildings,
			"landuse": landuse,
			"boundary": boundary
		};

		//add base maps and overlays into the map
		// L.control.layers(baseLayers,overlays).addTo(map);


		// legend
		// var div = L.DomUtil.create('div', 'info-legend');	
		// 	var titre1 = 'points';
		// 	contents1 = div.innerHTML = '<br><img src="http://localhost:8080/geoserver/wms?REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&WIDTH=20&HEIGHT=20&LAYER=first:points_cn" </img><br>';
			
		// 	var titre2 = 'railways';
		// 	contents2 = div.innerHTML = '<br><img src="http://localhost:8080/geoserver/wms?REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&WIDTH=20&HEIGHT=20&LAYER=first:railways_cn" </img><br>';

		// 	var titre3 = 'buildings';
		// 	contents3 = div.innerHTML = '<br><img src="http://localhost:8080/geoserver/wms?REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&WIDTH=20&HEIGHT=20&LAYER=first:buildings_cn" </img><br>';
			
		// 	var titre4 = 'landuse';
		// 	contents4 = div.innerHTML = '<br><img src="http://localhost:8080/geoserver/wms?REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&WIDTH=20&HEIGHT=20&LAYER=first:landuse_cn" </img><br>';
			
		// 	var titre5 = 'boundary';
		// 	contents5 = div.innerHTML = '<br><img src="http://localhost:8080/geoserver/wms?REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&WIDTH=20&HEIGHT=20&LAYER=first:boundary_cn" </img><br>';
			
		// 	// var titre6 = 'support_hta';
		// 	// contents6 = div.innerHTML = '<br><img src="http://localhost:8080/geoserver/wms?REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&WIDTH=20&HEIGHT=20&LAYER=first:support_hta" </img><br>';
			
		// 	var slideMenu = L.control.slideMenu('', {position: 'topright', delay: '5'}).addTo(map);
		// 	slideMenu.setContents(titre1 + contents1 + titre2 + contents2 + titre3 + contents3 + titre4 + contents4 + titre5 + contents5 );//+ titre6 + contents6 );






        //----------------------------------------------------------------------------------
		// colour computing
        //----------------------------------------------------------------------------------

        function rgbToHex(r, g, b)
        {
            var hex = ((r<<16) | (g<<8) | b).toString(16);
            return "#" + new Array(Math.abs(hex.length-7)).join("0") + hex;
        }

        function hexToRgb(hex)
        {
            var rgb = [];
            for(var i=1; i<7; i+=2){
                rgb.push(parseInt("0x" + hex.slice(i,i+2)));
            }
            return rgb;
        }

		function gradient(startColor,endColor,step)
		{
			//将hex转换为rgb
			var sColor = hexToRgb(startColor),
				eColor = hexToRgb(endColor);

			//计算R\G\B每一步的差值
			var rStep = (eColor[0] - sColor[0]) / step;
			gStep = (eColor[1] - sColor[1]) / step;
			bStep = (eColor[2] - sColor[2]) / step;

			var gradientColorArr = [];
			for(var i=0;i<step;i++){
				//计算每一步的hex值
				gradientColorArr.push(rgbToHex(parseInt(rStep*i+sColor[0]),parseInt(gStep*i+sColor[1]),parseInt(bStep*i+sColor[2])));
			}
			return gradientColorArr;
		}

        //----------------------------------------------------------------------------------
        // display geojson layer
        //----------------------------------------------------------------------------------


        var transportationStyle = {
            "color": "#2340b9",
            "weight": 1,
            "opacity": 0.01
        };

        var nature_resourceStyle = {
            "color": "#60ee4c",
            "weight": 1,
            "opacity": 0.5
        };

        var tourism_resourceStyle = {
            "color": "#ee823d",
            "weight": 1,
            "opacity": 0.5
        };

        var educationStyle = {
            "color": "#ee3b9b",
            "weight": 1,
            "opacity": 0.5
        };

        var energyStyle = {
            "color": "#4c4a4c",
            "weight": 1,
            "opacity": 0.5
        };

        var pollutionStyle = {
            "color": "#1b191b",
            "weight": 1,
            "opacity": 0.5
        };

        var geojsonMarkerOptions = {
            radius: 8,
            fillColor: "#ff2123",
            color: "#000",
            weight: 1,
            opacity: 1,
            fillOpacity: 0.8
        };

        // add geojson points to the map
        // L.geoJSON(geojsonFeature, {
        //     pointToLayer: function (feature, latlng) {
        //         return L.circleMarker(latlng, geojsonMarkerOptions);
        //     }
        // }).addTo(map);

        //add geojson polygon to the map
        var transportation = new L.geoJSON(transportation, {
            style: transportationStyle,
			onEachFeature: layersOnEachFeature
        });

        //add geojson polygon to the map
        var nature = new L.geoJSON(nature_resources, {
            style: nature_resourceStyle
        });

        //add geojson polygon to the map
        var tourism = new L.geoJSON(tourism_resources, {
            style: tourism_resourceStyle
        });

        //add geojson polygon to the map
        var edu = new L.geoJSON(education, {
            style: educationStyle
        });

        var energy = new L.geoJSON(energy, {
            style: energyStyle
        });

        var pollution = new L.geoJSON(pollution, {
            style: pollutionStyle
        });

		var overlays_geojson = {
		    "Transportation": transportation,
			"Nature resources": nature,
			"Tourism resources": tourism,
			"Education": edu,
			"Energy": energy,
			"Pollution": pollution
		};

		// add layer control to the map, overlays invisible by default
        L.control.layers(baseLayers,overlays_geojson).addTo(map);

        //----------------------------------------------------------------------------------
        // info box
        //----------------------------------------------------------------------------------


        var info = L.control();

        info.onAdd = function (map) {
            this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
            this.update();
            return this._div;
        };

        // method that we will use to update the control based on feature properties pacssed
        info.update = function (props) {
            this._div.innerHTML = '<h4>Data Information</h4>' +  (props ?
                '<b>' + props.title + '</b>' +'  '+ props.year
                : 'Choose a category');
        };

        info.addTo(map);

        function highlightFeature(e) {
            info.update(layer.feature.properties);
            console.log('highlightFeature');
        }

        function resetHighlight(e) {
            info.update();
        }

        function layersOnEachFeature(feature, layer) {
            layer.on({
                overlayadd: highlightFeature,
                overlayremove: resetHighlight
            });
        }

		map.on("overlayadd overlayremove", function (event) {
			var layer = event.layer;

			if (event.type == "overlayadd"){
				for(var l in layer._layers){
					var properties = layer._layers[l].feature.properties;
					// console.log(properties)
					info.update(properties)
				};

			} else {
                console.log('removed');
			    info.update();
			}
		});


	</script>
</body>























































